{% extends 'agendamentos/base.html' %}

{% block title %}Dashboard - {{ data_selecionada|date:"d/m/Y" }}{% endblock %}

{% block content %}

<div class="date-selector">
    <form method="GET" action="{% url 'painel_barbeiro' %}" id="date-form">
        <label for="data">
            <span class="icon icon-calendar"></span>Selecionar outra data:
        </label>
        <div class="custom-date-picker">
            <div class="date-input" id="date-input">
                <span id="date-text">{{ data_selecionada|date:"d/m/Y" }}</span>
                <span class="icon icon-calendar"></span>
            </div>
            <div class="date-dropdown" id="date-dropdown">
                <div class="date-nav">
                    <button type="button" id="prev-month">&lt;</button>
                    <span id="current-month"></span>
                    <button type="button" id="next-month">&gt;</button>
                </div>
                <div class="date-grid" id="date-grid"></div>
                <div class="date-actions">
                    <button type="button" id="today-btn">Hoje</button>
                    <button type="button" id="clear-btn">Limpar</button>
                </div>
            </div>
        </div>
        <input type="hidden" name="data" id="id_data" value="{{ data_selecionada|date:'Y-m-d' }}">
    </form>
</div>

<div class="dashboard-header mb-3">
    <h2>
        <span class="icon icon-calendar"></span>Agenda para {{ data_selecionada|date:"d/m/Y" }}
    </h2>
    <div class="dashboard-actions">
        <a href="{% url 'agendamentos_mensais' %}" class="btn btn-primary">
            <span class="icon icon-calendar"></span><span class="btn-text">Agendamentos Mensais</span>
        </a>
        <a href="{% url 'criar_cliente' %}" class="btn btn-success">
            <span class="icon icon-add"></span><span class="btn-text">Novo Cliente</span>
        </a>
    </div>
</div>

{% if agendamentos %}
    <!-- CARDS DE AGENDAMENTOS -->
    <div class="mobile-appointments">
        {% for agendamento in agendamentos %}
        <div class="appointment-card">
            <div class="appointment-header">
                <div class="appointment-main-info">
                    <div class="appointment-time">{{ agendamento.hora|time:"H:i" }}</div>
                    <div class="appointment-client-name">{{ agendamento.cliente.nome }}</div>
                </div>
                <div class="appointment-status 
                    {% if agendamento.status == 'confirmado' %}status-confirmado
                    {% elif agendamento.status == 'a_caminho' %}status-a-caminho
                    {% elif agendamento.status == 'concluido' %}status-concluido
                    {% elif agendamento.status == 'cancelado' %}status-cancelado
                    {% endif %}">
                    {% if agendamento.status == 'confirmado' %}PENDENTE
                    {% elif agendamento.status == 'a_caminho' %}√Ä CAMINHO
                    {% elif agendamento.status == 'concluido' %}CONCLU√çDO
                    {% elif agendamento.status == 'cancelado' %}CANCELADO
                    {% endif %}
                </div>
            </div>
            
            <div class="appointment-info">
                <div class="appointment-info-row">
                    <span class="appointment-info-label">
                        <span class="icon icon-phone"></span>Telefone:
                    </span>
                    <span class="appointment-info-value">
                        {% if agendamento.cliente.telefone %}
                            <a href="tel:{{ agendamento.cliente.telefone }}">{{ agendamento.cliente.telefone }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>
                
                <div class="appointment-info-row">
                    <span class="appointment-info-label">
                        <span class="icon icon-scissors"></span>Servi√ßo:
                    </span>
                    <span class="appointment-info-value">{{ agendamento.servico.nome }}</span>
                </div>
                
                {% if agendamento.cliente.endereco %}
                <div class="appointment-info-row">
                    <span class="appointment-info-label">
                        <span class="icon icon-location"></span>Endere√ßo:
                    </span>
                    <span class="appointment-info-value">
                        <a href="https://www.google.com/maps/search/?api=1&query={{ agendamento.cliente.endereco }}" target="_blank">
                            {{ agendamento.cliente.endereco|truncatechars:40 }}
                        </a>
                    </span>
                </div>
                {% endif %}
                
                <div class="appointment-info-row">
                    <span class="appointment-info-label">
                        <span class="icon icon-note"></span>Observa√ß√µes:
                    </span>
                    <span class="appointment-info-value observations-text">
                        {% if agendamento.observacoes %}
                            {{ agendamento.observacoes }}
                        {% else %}
                            <span class="no-observations">-</span>
                        {% endif %}
                    </span>
                </div>
                
                {% if agendamento.status == 'a_caminho' and agendamento.previsao_chegada %}
                <div class="appointment-info-row">
                    <span class="appointment-info-label">
                        <span class="icon icon-time"></span>Previs√£o de Chegada:
                    </span>
                    <span class="appointment-info-value" style="color: #3B82F6; font-weight: 700;">
                        {{ agendamento.previsao_chegada }} minutos
                    </span>
                </div>
                {% endif %}
            </div>
            
            <div class="appointment-actions">
                {% if agendamento.status == 'confirmado' %}
                    <form action="{% url 'on_the_way_agendamento' agendamento.id %}" method="post" style="display: inline; flex: 1;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-info">
                            <span class="icon icon-on-the-way"></span>√Ä caminho
                        </button>
                    </form>
                    <form action="{% url 'concluir_agendamento' agendamento.id %}" method="post" style="display: inline; flex: 1;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-success">
                            <span class="icon icon-barber"></span>Concluir
                        </button>
                    </form>
                {% elif agendamento.status == 'a_caminho' %}
                    <form action="{% url 'concluir_agendamento' agendamento.id %}" method="post" style="display: inline; flex: 1;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-success">
                            <span class="icon icon-barber"></span>Concluir
                        </button>
                    </form>
                {% endif %}
                <a href="{% url 'editar_agendamento' agendamento.id %}" class="btn btn-sm btn-secondary" style="flex: 1;">
                    <span class="icon icon-edit"></span>Editar
                </a>
                <a href="{% url 'deletar_agendamento' agendamento.id %}" class="btn btn-sm btn-danger" style="flex: 1;">
                    <span class="icon icon-delete"></span>Deletar
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="no-appointments" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
        <p>Nenhum agendamento para a data selecionada.</p>
    </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// JavaScript para o calend√°rio customizado do dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Calend√°rio customizado
    const dateInput = document.getElementById('date-input');
    const dateDropdown = document.getElementById('date-dropdown');
    const dateText = document.getElementById('date-text');
    const hiddenDateField = document.getElementById('id_data');
    const currentMonthSpan = document.getElementById('current-month');
    const dateGrid = document.getElementById('date-grid');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const todayBtn = document.getElementById('today-btn');
    const clearBtn = document.getElementById('clear-btn');
    const dateForm = document.getElementById('date-form');

    let currentDate = new Date();
    // Corrigir inicializa√ß√£o da data selecionada para evitar problemas de fuso hor√°rio
    const selectedDateString = '{{ data_selecionada|date:"Y-m-d" }}';
    const [year, month, day] = selectedDateString.split('-').map(Number);
    let selectedDate = new Date(year, month - 1, day);

    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

    function updateCalendar() {
        currentMonthSpan.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        dateGrid.innerHTML = '';
        
        // Gerar exatamente 42 dias (6 semanas)
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'date-day';
            dayElement.textContent = date.getDate();
            
            if (date.getMonth() !== month) {
                dayElement.classList.add('other-month');
            }
            
            if (isToday(date)) {
                dayElement.classList.add('today');
            }
            
            if (selectedDate && isSameDate(date, selectedDate)) {
                dayElement.classList.add('selected');
            }
            
            if (date.getMonth() === month) {
                dayElement.addEventListener('click', () => selectDate(date));
            }
            
            dateGrid.appendChild(dayElement);
        }
    }

    function selectDate(date) {
        selectedDate = date;
        // Corrigir problema de fuso hor√°rio usando getFullYear, getMonth e getDate
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        const formattedDate = `${day}/${month}/${year}`;
        
        dateText.textContent = formattedDate;
        hiddenDateField.value = dateString;
        dateDropdown.classList.remove('active');
        updateCalendar();
        
        // Submeter o formul√°rio automaticamente
        dateForm.submit();
    }

    function isToday(date) {
        const today = new Date();
        return date.toDateString() === today.toDateString();
    }

    function isSameDate(date1, date2) {
        if (!date1 || !date2) return false;
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
    }

    // Event listeners
    dateInput.addEventListener('click', (e) => {
        e.stopPropagation();
        dateDropdown.classList.toggle('active');
    });

    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendar();
    });

    todayBtn.addEventListener('click', () => selectDate(new Date()));
    clearBtn.addEventListener('click', () => {
        selectedDate = null;
        dateText.textContent = 'Selecione uma data';
        hiddenDateField.value = '';
        dateDropdown.classList.remove('active');
        updateCalendar();
    });

    document.addEventListener('click', () => dateDropdown.classList.remove('active'));
    dateDropdown.addEventListener('click', (e) => e.stopPropagation());

    // Debug: verificar data inicial
    console.log('Data selecionada inicial:', selectedDate);
    console.log('String da data:', selectedDateString);
    
    // Inicializar
    updateCalendar();
});
</script>
{% endblock %}