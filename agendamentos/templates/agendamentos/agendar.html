{% extends 'agendamentos/base.html' %}

{% block title %}Novo Agendamento{% endblock %}

{% block content %}
<h2>Novo Agendamento</h2>
<form method="post" id="agendamento-form">
    {% csrf_token %}

    {{ form.servico.label_tag }}
    {{ form.servico }}

    {{ form.data.label_tag }}
    {{ form.data }}

    {{ form.hora.as_hidden }}

    <div id="horarios-disponiveis-container">
        <label>Horários disponíveis:</label>
        <div id="horarios-grid" class="horarios-grid">
            <p>Por favor, selecione uma data para ver os horários.</p>
        </div>
    </div>

    <button type="submit">Confirmar Agendamento</button>
</form>
{% endblock %} {# <--- ESTA LINHA ESTAVA FALTANDO ANTES DO BLOCO DE JAVASCRIPT #}


{# Bloco para adicionar nosso JavaScript no final da página #}
{% block extra_js %}
<script>
    // Pega os elementos do formulário que vamos usar
    const servicoInput = document.getElementById('id_servico');
    const dataInput = document.getElementById('id_data');
    const horariosGrid = document.getElementById('horarios-grid');
    const horaInputHidden = document.getElementById('id_hora');

    // Cria uma função reutilizável para buscar os horários
    function buscarHorarios() {
        const dataSelecionada = dataInput.value;
        const servicoId = servicoInput.value;

        // Limpa os horários e mostra uma mensagem
        horariosGrid.innerHTML = '<p>Carregando horários...</p>';
        horaInputHidden.value = ''; // Limpa a hora selecionada

        // Só busca se AMBOS, data e serviço, estiverem selecionados
        if (!dataSelecionada || !servicoId) {
            horariosGrid.innerHTML = '<p>Por favor, selecione um serviço e uma data.</p>';
            return;
        }

        // Faz a chamada para a nossa API, agora enviando data E serviço
        fetch(`/api/horarios-disponiveis/?data=${dataSelecionada}&servico_id=${servicoId}`)
            .then(response => response.json())
            .then(data => {
                horariosGrid.innerHTML = ''; 

                if (data.horarios.length === 0) {
                    horariosGrid.innerHTML = '<p>Nenhum horário disponível para este serviço nesta data.</p>';
                } else {
                    data.horarios.forEach(horario => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'horario-btn';
                        button.textContent = horario;

                        button.addEventListener('click', function() {
                            horaInputHidden.value = horario;
                            document.querySelectorAll('.horario-btn').forEach(btn => btn.classList.remove('selected'));
                            this.classList.add('selected');
                        });

                        horariosGrid.appendChild(button);
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao buscar horários:', error);
                horariosGrid.innerHTML = '<p>Ocorreu um erro ao buscar os horários.</p>';
            });
    }

    // Adiciona "ouvintes" que disparam a função quando a data OU o serviço são alterados
    dataInput.addEventListener('change', buscarHorarios);
    servicoInput.addEventListener('change', buscarHorarios);
</script>
{% endblock %}