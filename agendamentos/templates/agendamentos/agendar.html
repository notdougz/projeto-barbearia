{% extends 'agendamentos/base.html' %}

{% block title %}Novo Agendamento{% endblock %}

{% block content %}
<h2>Novo Agendamento</h2>
<form method="post" id="agendamento-form">
    {% csrf_token %}

    {{ form.servico.label_tag }}
    {{ form.servico }}

    {{ form.data.label_tag }}
    {{ form.data }}

    {{ form.hora.as_hidden }}

    <div id="horarios-disponiveis-container">
        <label>Horários disponíveis:</label>
        <div id="horarios-grid" class="horarios-grid">
            <p>Por favor, selecione uma data para ver os horários.</p>
        </div>
    </div>

    <button type="submit">Confirmar Agendamento</button>
</form>
{% endblock %} {# <--- ESTA LINHA ESTAVA FALTANDO ANTES DO BLOCO DE JAVASCRIPT #}


{# Bloco para adicionar nosso JavaScript no final da página #}
{% block extra_js %}
<script>
    // Pega os elementos do formulário que vamos usar
    const dataInput = document.getElementById('id_data');
    const horariosGrid = document.getElementById('horarios-grid');
    const horaInputHidden = document.getElementById('id_hora');

    // Adiciona um "ouvinte" que dispara uma função quando a data é alterada
    dataInput.addEventListener('change', function() {
        const dataSelecionada = this.value;

        // Limpa os horários antigos e mostra uma mensagem de carregamento
        horariosGrid.innerHTML = '<p>Carregando horários...</p>';

        // Se nenhuma data for selecionada, não faz nada
        if (!dataSelecionada) {
            horariosGrid.innerHTML = '<p>Por favor, selecione uma data para ver os horários.</p>';
            return;
        }

        // Faz a chamada para a nossa API
        fetch(`/api/horarios-disponiveis/?data=${dataSelecionada}`)
            .then(response => response.json())
            .then(data => {
                horariosGrid.innerHTML = ''; // Limpa a mensagem de carregamento

                if (data.horarios.length === 0) {
                    horariosGrid.innerHTML = '<p>Nenhum horário disponível para esta data.</p>';
                } else {
                    // Para cada horário recebido da API, cria um botão
                    data.horarios.forEach(horario => {
                        const button = document.createElement('button');
                        button.type = 'button'; // Importante para não submeter o formulário
                        button.className = 'horario-btn';
                        button.textContent = horario;
                        
                        // Adiciona um "ouvinte" para o clique no botão de horário
                        button.addEventListener('click', function() {
                            // Preenche o campo de hora escondido com o valor do botão
                            horaInputHidden.value = horario;

                            // Remove a seleção de outros botões e destaca o clicado
                            document.querySelectorAll('.horario-btn').forEach(btn => btn.classList.remove('selected'));
                            this.classList.add('selected');
                        });

                        horariosGrid.appendChild(button);
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao buscar horários:', error);
                horariosGrid.innerHTML = '<p>Ocorreu um erro ao buscar os horários. Tente novamente.</p>';
            });
    });
</script>
{% endblock %}