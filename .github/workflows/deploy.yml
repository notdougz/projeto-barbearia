name: ğŸš€ CD - Deploy AutomÃ¡tico

# Quando executar este workflow
on:
  push:
    branches: [main]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

# Jobs que serÃ£o executados
jobs:
  # Job 1: Deploy para Railway
  deploy:
    name: ğŸš€ Deploy para Railway
    runs-on: ubuntu-latest

    # SÃ³ executa se os testes passaram
    needs: [] # Remover esta linha quando tiver o job de testes

    steps:
      # Passo 1: Checkout do cÃ³digo
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      # Passo 2: Configurar Python
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # Passo 3: Instalar Railway CLI
      - name: ğŸš‚ Instalar Railway CLI
        run: |
          npm install -g @railway/cli

      # Passo 4: Login no Railway
      - name: ğŸ” Login no Railway
        run: |
          railway login --token ${{ secrets.RAILWAY_TOKEN }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # Passo 5: Deploy
      - name: ğŸš€ Deploy para Railway
        run: |
          railway up --service ${{ secrets.RAILWAY_SERVICE_NAME }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # Passo 6: Verificar deploy
      - name: âœ… Verificar deploy
        run: |
          echo "Deploy realizado com sucesso!"
          echo "AplicaÃ§Ã£o disponÃ­vel em: https://${{ secrets.RAILWAY_DOMAIN }}"

  # Job 2: NotificaÃ§Ã£o de deploy
  notify:
    name: ğŸ“¢ Notificar Deploy
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      # Passo 1: Notificar sucesso
      - name: âœ… Notificar sucesso
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ Deploy realizado com sucesso!"
          echo "ğŸ“± AplicaÃ§Ã£o atualizada e funcionando"

      # Passo 2: Notificar erro
      - name: âŒ Notificar erro
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deploy falhou!"
          echo "ğŸ” Verifique os logs para mais detalhes"
          exit 1
